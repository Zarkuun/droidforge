#!/bin/bash
set -e

NAME="DROID Forge"
QT_DIR=~/Qt/6.3.1
PATH=$PATH:$QT_DIR/macos/bin
APP_ICON=droidforge/droidforge.icns
INSTALL_ROOT=droidforge/build/release-mac/install-root/usr/local/Applications
APP_DIR="$INSTALL_ROOT/$NAME.app"
DMG="$INSTALL_ROOT/$NAME.dmg"
TARGET_INFO_PLIST=$APP_DIR/Contents/Info.plist

# First build the project

echo "Cleaning old build..."
rm -rf "$APP_DIR"
echo "Now do the Release-build in QtCreator and press enter!"
read
echo "Continuing..."


if [ ! -e "$APP_DIR" ] ; then
    echo "$APP_DIR missing. Please build release in Qt creator."
    exit 1
fi

echo -n "Fixing rpath..."
install_name_tool -add_rpath @loader_path/../Frameworks "$APP_DIR/Contents/MacOS/$NAME"
echo OK

echo -n "Installing Info.plist..."
cp -v Info.plist "$TARGET_INFO_PLIST"
echo OK

echo -n "Installing icon..."
mkdir -p "$APP_DIR/Contents/Resources"
cp -v "$APP_ICON" "$APP_DIR/Contents/Resources"
echo OK

echo -n "Creating DMG..."
rm -f "$DMG"
macdeployqt "$APP_DIR" -dmg
echo OK
